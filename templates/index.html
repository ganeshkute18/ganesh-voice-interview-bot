<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ganesh ‚Äì AI Interview Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light;
      --bg: #f4f6fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --accent: #1d4ed8;
      --accent-soft: rgba(29, 78, 216, 0.08);
      --success: #16a34a;
      --warning: #f97316;
      --shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 18px 48px;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-mark {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background: linear-gradient(140deg, #1d4ed8, #60a5fa);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 700;
      letter-spacing: 0.06em;
    }

    .brand h1 {
      font-size: 1.5rem;
      font-weight: 650;
    }

    .brand p {
      color: var(--muted);
      font-size: 0.92rem;
      margin-top: 4px;
    }

    .status-pill {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 0.78rem;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 22px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card h2 {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .card p {
      color: var(--muted);
      font-size: 0.85rem;
      line-height: 1.4;
    }

    label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
      display: block;
    }

    input,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 0.92rem;
      background: #fff;
      color: var(--text);
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    button {
      border: none;
      cursor: pointer;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.88rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 18px rgba(29, 78, 216, 0.25);
    }

    .secondary {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .warning {
      background: rgba(249, 115, 22, 0.1);
      color: var(--warning);
      border: 1px solid rgba(249, 115, 22, 0.3);
    }

    .success {
      background: rgba(22, 163, 74, 0.12);
      color: var(--success);
      border: 1px solid rgba(22, 163, 74, 0.3);
    }

    .question-area {
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 16px;
      min-height: 180px;
      background: #f8fafc;
      overflow-y: auto;
    }

    .bubble {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .bubble .role-label {
      font-size: 0.68rem;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.08em;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    #status,
    #resumeStatus {
      font-size: 0.78rem;
      color: var(--muted);
    }

    #resumeOutput {
      min-height: 100px;
      background: #f8fafc;
    }

    .footer-note {
      text-align: center;
      color: var(--muted);
      font-size: 0.78rem;
    }

    @media (max-width: 720px) {
      body {
        padding: 20px 14px 32px;
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div class="brand">
        <div class="brand-mark">AI</div>
        <div>
          <h1>Ganesh Interview Console</h1>
          <p>Configure the role, add candidate details, and run a structured AI interview.</p>
        </div>
      </div>
      <div class="status-pill">Enterprise Ready</div>
    </header>

    <section class="grid">
      <div class="card">
        <h2>Company Setup</h2>
        <p>Capture the target role and interview rubric for consistent candidate evaluation.</p>
        <div>
          <label for="jobRole">Job Role</label>
          <input id="jobRole" type="text" placeholder="Senior Product Designer" />
        </div>
        <div>
          <label for="skills">Skills (comma separated)</label>
          <input id="skills" type="text" placeholder="UX research, Prototyping, Design systems" />
        </div>
        <div>
          <label for="jobDescription">Job Description</label>
          <textarea id="jobDescription" placeholder="Outline responsibilities, expectations, and success metrics."></textarea>
        </div>
        <div class="actions">
          <button class="primary" id="saveJobBtn">üíæ Save Job</button>
          <span id="status"></span>
        </div>
      </div>

      <div class="card">
        <h2>Candidate Setup</h2>
        <p>Upload a resume to pre-fill context for the AI interviewer.</p>
        <div>
          <label for="resumeInput">Resume Upload</label>
          <input id="resumeInput" type="file" accept=".pdf,.docx" />
        </div>
        <div class="actions">
          <button id="uploadBtn" class="secondary">‚¨ÜÔ∏è Upload Resume</button>
          <span id="resumeStatus"></span>
        </div>
        <textarea id="resumeOutput" placeholder="Extracted resume text will appear here..." readonly></textarea>
      </div>

      <div class="card">
        <h2>Interview Section</h2>
        <p>Launch the interview and review the latest AI-generated questions.</p>
        <div id="chat" class="question-area"></div>
        <div class="actions">
          <button id="recordBtn" class="primary">‚ñ∂Ô∏è Start Interview</button>
          <button id="stopListenBtn" class="secondary" disabled>‚è∏Ô∏è Pause</button>
          <button id="stopVoiceBtn" class="secondary">üîá Mute Voice</button>
          <button id="clearBtn" class="warning">üßπ Clear</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Manual Input</h2>
      <p>Type a custom question or prompt to keep the interview moving.</p>
      <input id="typedInput" placeholder="Type a question for the candidate..." />
      <button id="sendBtn" class="success">Send Question</button>
    </section>

    <div class="footer-note">Tip: Use clear, role-specific questions for consistent scoring.</div>
  </div>

  <script>
    const recordBtn = document.getElementById("recordBtn");
    const stopListenBtn = document.getElementById("stopListenBtn");
    const stopVoiceBtn = document.getElementById("stopVoiceBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusEl = document.getElementById("status");
    const chatEl = document.getElementById("chat");
    const typedInput = document.getElementById("typedInput");
    const sendBtn = document.getElementById("sendBtn");
    const saveJobBtn = document.getElementById("saveJobBtn");
    const jobRole = document.getElementById("jobRole");
    const skills = document.getElementById("skills");
    const jobDescription = document.getElementById("jobDescription");
    const resumeInput = document.getElementById("resumeInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const resumeStatus = document.getElementById("resumeStatus");
    const resumeOutput = document.getElementById("resumeOutput");

    let recognition;
    let recognizing = false;
    let history = [];
    let selectedVoice = null;

    function loadVoices() {
      const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
      if (!voices || !voices.length) return;

      selectedVoice =
        voices.find(v => v.name.includes("Google UK English Male")) ||
        voices.find(v => v.name.includes("Google US English")) ||
        voices.find(v => v.lang === "en-IN" && v.name.toLowerCase().includes("male")) ||
        voices[0];
    }
    if ("speechSynthesis" in window) {
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    function speak(text) {
      if (!window.speechSynthesis) return;

      const utterance = new SpeechSynthesisUtterance(text);
      if (selectedVoice) utterance.voice = selectedVoice;

      utterance.rate = 1.02;
      utterance.pitch = 0.98;
      utterance.volume = 1.0;

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    stopVoiceBtn.addEventListener("click", () => {
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
        statusEl.textContent = "Voice muted.";
        setTimeout(() => { if (statusEl.textContent === "Voice muted.") statusEl.textContent = ""; }, 900);
      }
    });

    function addMessage(text, role) {
      const wrapper = document.createElement("div");
      wrapper.className = "bubble";

      const label = document.createElement("div");
      label.className = "role-label";
      label.textContent = role === "user" ? "INTERVIEWER" : "AI";

      const body = document.createElement("div");
      body.textContent = text;

      wrapper.appendChild(label);
      wrapper.appendChild(body);

      chatEl.appendChild(wrapper);
      chatEl.scrollTop = chatEl.scrollHeight;

      history.push({ role: role === "user" ? "user" : "assistant", content: text });
    }

    function setupRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        statusEl.textContent = "Speech recognition is not supported in this browser. Try Chrome.";
        recordBtn.disabled = true;
        stopListenBtn.disabled = true;
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        recognizing = true;
        statusEl.textContent = "Listening for the next question...";
      };
      recognition.onend = () => {
        recognizing = false;
        recordBtn.disabled = false;
        stopListenBtn.disabled = true;
        if (!statusEl.textContent.startsWith("Thinking")) {
          statusEl.textContent = "";
        }
      };
      recognition.onerror = (event) => {
        recognizing = false;
        recordBtn.disabled = false;
        stopListenBtn.disabled = true;
        console.error("Recognition error:", event);
        statusEl.textContent = "Could not hear clearly. Please try again.";
      };
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        addMessage(transcript, "user");
        sendToServer(transcript);
      };
    }

    async function sendToServer(message) {
      statusEl.textContent = "Thinking‚Ä¶";
      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, history }),
        });
        const data = await res.json();
        if (data.reply) {
          addMessage(data.reply, "bot");
          speak(data.reply);
          statusEl.textContent = "";
        } else {
          statusEl.textContent = "Error from server.";
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Network error. Please try again.";
      }
    }

    async function uploadResume() {
      const file = resumeInput.files[0];
      if (!file) {
        resumeStatus.textContent = "Please choose a PDF or DOCX file.";
        return;
      }
      resumeStatus.textContent = "Uploading and extracting...";
      resumeOutput.value = "";

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("/upload_resume", {
          method: "POST",
          body: formData,
        });
        const data = await res.json();
        if (!res.ok) {
          resumeStatus.textContent = data.error || "Upload failed.";
          return;
        }
        resumeStatus.textContent = `Uploaded ${data.filename}.`;
        resumeOutput.value = data.text || "";
      } catch (err) {
        console.error(err);
        resumeStatus.textContent = "Network error while uploading.";
      }
    }

    async function saveJob() {
      const payload = {
        role: jobRole.value.trim(),
        description: jobDescription.value.trim(),
        skills: skills.value
          .split(",")
          .map(skill => skill.trim())
          .filter(Boolean),
      };

      if (!payload.role || !payload.description || payload.skills.length === 0) {
        statusEl.textContent = "Please complete role, skills, and description.";
        return;
      }

      statusEl.textContent = "Saving job profile...";
      try {
        const res = await fetch("/set-job", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = data.error || "Unable to save job profile.";
          return;
        }
        statusEl.textContent = "Job profile saved.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Network error while saving.";
      }
    }

    recordBtn.addEventListener("click", () => {
      if (!recognition) return;
      if (!recognizing) {
        recordBtn.disabled = true;
        stopListenBtn.disabled = false;
        recognition.start();
      }
    });

    stopListenBtn.addEventListener("click", () => {
      if (recognition && recognizing) {
        recognition.stop();
      }
    });

    sendBtn.addEventListener("click", () => {
      const text = typedInput.value.trim();
      if (!text) return;
      typedInput.value = "";
      addMessage(text, "user");
      sendToServer(text);
    });

    typedInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendBtn.click();
      }
    });

    clearBtn.addEventListener("click", () => {
      chatEl.innerHTML = "";
      history = [];
      statusEl.textContent = "Interview log cleared.";
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      setTimeout(() => { if (statusEl.textContent === "Interview log cleared.") statusEl.textContent = ""; }, 900);
    });

    saveJobBtn.addEventListener("click", saveJob);
    uploadBtn.addEventListener("click", uploadResume);

    setupRecognition();
  </script>
</body>
</html>
